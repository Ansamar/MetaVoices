<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaVoices - Anteprima Finale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="assets/images/Metavoices.png" alt="MetaVoices" class="logo-image">
                <h1>MetaVoices</h1>
                <span class="version">v3.0</span>
            </div>
            <div class="header-actions">
                <div class="progress-indicator">
                    <span class="progress-step">1</span>
                    <span class="progress-step">2</span>
                    <span class="progress-step">3</span>
                    <span class="progress-step active">4</span>
                    <span class="progress-label">Anteprima</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Contenuto principale -->
    <main class="main-content vertical-flow">
        <!-- Riepilogo -->
        <section class="text-section">
            <div class="section-header">
                <h2><i class="fas fa-clipboard-check"></i> Riepilogo Generale</h2>
            </div>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-icon"><i class="fas fa-microphone"></i></div>
                    <div class="summary-content">
                        <h3>Voce Selezionata</h3>
                        <p id="summaryVoice">-</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon"><i class="fas fa-file-alt"></i></div>
                    <div class="summary-content">
                        <h3>Testo</h3>
                        <p id="summaryText">-</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon"><i class="fas fa-magic"></i></div>
                    <div class="summary-content">
                        <h3>Correzioni</h3>
                        <p id="summaryCorrections">-</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon"><i class="fas fa-code"></i></div>
                    <div class="summary-content">
                        <h3>Controlli SSML</h3>
                        <p id="summarySSML">-</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Testo Finale -->
        <section class="text-section">
            <div class="section-header">
                <h2><i class="fas fa-edit"></i> Testo Finale</h2>
                <div class="text-actions">
                    <button id="copyTextBtn" class="btn-secondary">
                        <i class="fas fa-copy"></i> Copia Testo
                    </button>
                </div>
            </div>
            <div class="text-container">
                <div class="text-display" id="finalTextDisplay">
                    Caricamento testo...
                </div>
            </div>
        </section>

        <!-- Player Audio -->
        <section class="text-section">
            <div class="section-header">
                <h2><i class="fas fa-play-circle"></i> Anteprima Audio</h2>
            </div>
            <div class="player-container">
                <div class="player-controls">
                    <button id="playBtn" class="btn-primary">
                        <i class="fas fa-play"></i> Riproduci
                    </button>
                    <button id="pauseBtn" class="btn-secondary" disabled>
                        <i class="fas fa-pause"></i> Pausa
                    </button>
                    <button id="stopBtn" class="btn-secondary" disabled>
                        <i class="fas fa-stop"></i> Stop
                    </button>
                </div>
                <div class="player-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-time">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
                <div class="player-settings">
                    <div class="setting-group">
                        <label for="playbackRate">Velocit√†:</label>
                        <select id="playbackRate">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label for="volumeControl">Volume:</label>
                        <input type="range" id="volumeControl" min="0" max="100" value="80">
                        <span id="volumeValue">80%</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Esportazione -->
        <section class="text-section">
            <div class="section-header">
                <h2><i class="fas fa-download"></i> Esportazione</h2>
            </div>
            <div class="export-options">
                <div class="export-actions">
                    <button id="generateAudioBtn" class="btn-primary">
                        <i class="fas fa-bolt"></i> Genera Audio
                    </button>
                    <button id="downloadBtn" class="btn-success" disabled>
                        <i class="fas fa-download"></i> Scarica MP3
                    </button>
                </div>
            </div>
        </section>

        <!-- Navigazione -->
        <section class="navigation-section">
            <div class="nav-actions">
                <button id="backBtn" class="btn-secondary">
                    <i class="fas fa-arrow-left"></i> Torna a SSML
                </button>
                <button id="newProjectBtn" class="btn-primary">
                    <i class="fas fa-plus"></i> Nuovo Progetto
                </button>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-status">
                <div id="statusMessage" class="status"></div>
            </div>
        </div>
    </footer>

    <!-- Audio Player -->
    <audio id="audioPlayer"></audio>

    <!-- Script -->
    <script>
        // Lo stesso JavaScript funzionante di prima
        class PreviewApp {
            constructor() {
                this.audio = document.getElementById('audioPlayer');
                this.audioBlob = null;
                this.init();
            }

            init() {
                console.log('üöÄ Preview App - Inizializzazione');
                this.loadData();
                this.setupEventListeners();
                this.setupAudioPlayer();
            }

            loadData() {
                const voiceData = localStorage.getItem('metavoices_data');
                if (voiceData) {
                    const data = JSON.parse(voiceData);
                    this.updateSummary(data);
                    this.displayText(data.text);
                }
            }

            updateSummary(data) {
                document.getElementById('summaryVoice').textContent = data.voiceName || 'Non specificata';
                
                const textElem = document.getElementById('summaryText');
                if (textElem && data.text) {
                    const words = data.text.trim().split(/\s+/).length;
                    const chars = data.text.length;
                    textElem.textContent = `${words} parole, ${chars} caratteri`;
                }

                document.getElementById('summaryCorrections').textContent = '0 correzioni';
                document.getElementById('summarySSML').textContent = '0 controlli';
            }

            displayText(text) {
                document.getElementById('finalTextDisplay').textContent = text || 'Nessun testo disponibile';
            }

            setupEventListeners() {
                document.getElementById('backBtn').addEventListener('click', () => {
                    window.location.href = 'ssml.html';
                });

                document.getElementById('newProjectBtn').addEventListener('click', () => {
                    if (confirm('Vuoi iniziare un nuovo progetto?')) {
                        localStorage.clear();
                        window.location.href = 'index.html';
                    }
                });

                document.getElementById('playBtn').addEventListener('click', () => this.playAudio());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pauseAudio());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopAudio());

                document.getElementById('playbackRate').addEventListener('change', (e) => {
                    this.audio.playbackRate = parseFloat(e.target.value);
                });

                document.getElementById('volumeControl').addEventListener('input', (e) => {
                    const volume = e.target.value;
                    this.audio.volume = volume / 100;
                    document.getElementById('volumeValue').textContent = volume + '%';
                });

                document.getElementById('copyTextBtn').addEventListener('click', () => this.copyText());
                document.getElementById('generateAudioBtn').addEventListener('click', () => this.generateAudio());
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadAudio());
            }

            setupAudioPlayer() {
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('loadedmetadata', () => this.updateDuration());
                this.audio.addEventListener('ended', () => this.onAudioEnd());
            }

            async generateAudio() {
                this.showStatus('Generazione audio in corso...', 'info');
                
                try {
                    const voiceData = JSON.parse(localStorage.getItem('metavoices_data'));
                    if (!voiceData) throw new Error('Nessun dato voce trovato');

                    const apiKey = localStorage.getItem('elevenlabs_api_key');
                    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceData.voiceId}`, {
                        method: 'POST',
                        headers: {
                            'Xi-Api-Key': apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: voiceData.text,
                            model_id: "eleven_multilingual_v2",
                            voice_settings: {
                                stability: 0.5,
                                similarity_boost: 0.5
                            }
                        })
                    });

                    if (!response.ok) throw new Error('Errore API');

                    this.audioBlob = await response.blob();
                    const url = URL.createObjectURL(this.audioBlob);
                    this.audio.src = url;
                    
                    this.showStatus('Audio generato con successo!', 'success');
                    document.getElementById('downloadBtn').disabled = false;

                } catch (error) {
                    console.error('Errore:', error);
                    this.showStatus('Errore nella generazione audio', 'error');
                }
            }

            downloadAudio() {
                if (!this.audioBlob) return;
                
                const url = URL.createObjectURL(this.audioBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'metavoices-audio.mp3';
                a.click();
                URL.revokeObjectURL(url);
            }

            playAudio() {
                if (!this.audio.src) {
                    this.showStatus('Prima genera l\'audio', 'error');
                    return;
                }
                this.audio.play();
                this.updatePlayerState(true);
            }

            pauseAudio() {
                this.audio.pause();
                this.updatePlayerState(false);
            }

            stopAudio() {
                this.audio.pause();
                this.audio.currentTime = 0;
                this.updatePlayerState(false);
                this.updateProgress();
            }

            onAudioEnd() {
                this.updatePlayerState(false);
            }

            updatePlayerState(playing) {
                const playBtn = document.getElementById('playBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const stopBtn = document.getElementById('stopBtn');

                playBtn.disabled = playing;
                pauseBtn.disabled = !playing;
                stopBtn.disabled = !playing;
            }

            updateProgress() {
                const progress = document.getElementById('progressFill');
                const currentTime = document.getElementById('currentTime');
                
                if (this.audio.duration) {
                    const percent = (this.audio.currentTime / this.audio.duration) * 100;
                    progress.style.width = percent + '%';
                }
                
                currentTime.textContent = this.formatTime(this.audio.currentTime);
            }

            updateDuration() {
                const duration = document.getElementById('duration');
                duration.textContent = this.formatTime(this.audio.duration);
            }

            formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            copyText() {
                const text = document.getElementById('finalTextDisplay').textContent;
                navigator.clipboard.writeText(text)
                    .then(() => this.showStatus('Testo copiato!', 'success'))
                    .catch(() => this.showStatus('Errore copia', 'error'));
            }

            showStatus(message, type) {
                const status = document.getElementById('statusMessage');
                status.textContent = message;
                status.className = `status status-${type}`;
                setTimeout(() => {
                    status.textContent = '';
                    status.className = 'status';
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.previewApp = new PreviewApp();
        });
    </script>
</body>
</html>